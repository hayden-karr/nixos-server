# Immich Server - Photo management application
# PRODUCTION DEPLOYMENT - Single node with multi-node migration path
#
# NOTE: This manifest requires ESO (External Secrets Operator) to be configured
# ESO syncs secrets from Vault to Kubernetes secrets:
#   - postgres-credentials (contains: password)
#
# CURRENT: Single-node with hostPath storage (shares data with podman)
# MULTI-NODE MIGRATION:
#   1. Deploy network storage (NFS for ReadWriteMany access)
#   2. Replace all hostPath volumes with PVCs using NFS/CephFS
#   3. Increase replicas to 2-3 for HA
#   4. Add pod anti-affinity to distribute across nodes
#   5. Use Redis Sentinel and PostgreSQL HA
#   6. Consider splitting into microservices (API, ML, etc.)
#
# STORAGE TIERS:
#   - Library/Videos: HDD (originals, encoded-video, backups)
#   - Fast access: SSD (thumbs, profile, upload)

apiVersion: apps/v1
kind: Deployment
metadata:
  name: immich
  namespace: immich-friend
  labels:
    app: immich
    tier: app
spec:
  # SINGLE NODE: 1 replica
  # MULTI-NODE: Increase to 2-3, requires ReadWriteMany storage
  replicas: 1
  selector:
    matchLabels:
      app: immich
      tier: app
  template:
    metadata:
      labels:
        app: immich
        tier: app
    spec:
      # Disable automatic service environment variable injection
      # Kubernetes creates IMMICH_PORT env vars that conflict with Immich's config
      enableServiceLinks: false

      initContainers:
        - name: config-setup
          image: busybox:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              cp /config-template/config.yaml /config/config.yaml
              sed -i "s|PLACEHOLDER_CLIENT_SECRET|$(cat /secrets/authelia/oauth-client-secret)|g" /config/config.yaml
              sed -i "s|PLACEHOLDER_AUTH_DOMAIN|$(cat /secrets/domains/authelia-domain)|g" /config/config.yaml
              sed -i "s|PLACEHOLDER_IMMICH_DOMAIN|$(cat /secrets/domains/immich-domain)|g" /config/config.yaml
              echo "Config generated successfully"
          volumeMounts:
            - name: config-template
              mountPath: /config-template
              readOnly: true
            - name: config
              mountPath: /config
            - name: authelia-secrets
              mountPath: /secrets/authelia
              readOnly: true
            - name: domain-secrets
              mountPath: /secrets/domains
              readOnly: true

      containers:
        - name: immich
          image: ghcr.io/immich-app/immich-server:release
          ports:
            - containerPort: 2283
              name: http
          env:
            - name: DB_HOSTNAME
              value: postgres
            - name: DB_PORT
              value: "5432"
            - name: DB_USERNAME
              value: immich
            - name: DB_DATABASE_NAME
              value: immich
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: password
            - name: REDIS_HOSTNAME
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: IMMICH_MACHINE_LEARNING_URL
              value: ""
            - name: UPLOAD_LOCATION
              value: /usr/src/app/upload
            - name: IMMICH_WORKERS_CONCURRENCY
              value: "1"
            - name: IMMICH_JOB_THUMBNAIL_GENERATION_CONCURRENCY
              value: "1"
            - name: IMMICH_JOB_METADATA_EXTRACTION_CONCURRENCY
              value: "1"
            - name: IMMICH_JOB_VIDEO_CONVERSION_CONCURRENCY
              value: "1"
            - name: IMMICH_CONFIG_FILE
              value: /config/config.yaml
          volumeMounts:
            - name: upload-library
              mountPath: /usr/src/app/upload/library
            - name: upload-thumbs
              mountPath: /usr/src/app/upload/thumbs
            - name: upload-encoded-video
              mountPath: /usr/src/app/upload/encoded-video
            - name: upload-profile
              mountPath: /usr/src/app/upload/profile
            - name: upload-upload
              mountPath: /usr/src/app/upload/upload
            - name: upload-backups
              mountPath: /usr/src/app/upload/backups
            - name: config
              mountPath: /config
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi

      volumes:
        - name: config-template
          configMap:
            name: immich-config-template
        - name: config
          emptyDir: {}
        - name: authelia-secrets
          secret:
            secretName: authelia-secrets
            items:
              - key: oauth-client-secret
                path: oauth-client-secret
        - name: domain-secrets
          secret:
            secretName: domain-secrets

        # STORAGE: hostPath for single-node (shares data with podman)
        # MULTI-NODE MIGRATION: Replace ALL volumes below with NFS PVCs
        # These paths must be ReadWriteMany for multiple pods
        #
        # Example PVC for library (repeat for each volume):
        #   - name: upload-library
        #     persistentVolumeClaim:
        #       claimName: immich-library-pvc
        #
        # TIERED STORAGE STRATEGY:
        #   HDD volumes: library, encoded-video, backups (large, infrequent access)
        #   SSD volumes: thumbs, profile, upload (small, frequent access)

        # Library - Original photos/videos (HDD)
        - name: upload-library
          hostPath:
            path: /mnt/storage/immich_friend/k3s/originals
            type: DirectoryOrCreate

        # Thumbnails - Frequent access (SSD)
        - name: upload-thumbs
          hostPath:
            path: /mnt/ssd/immich_friend/k3s/thumbs
            type: DirectoryOrCreate

        # Encoded videos - Transcoded media (HDD)
        - name: upload-encoded-video
          hostPath:
            path: /mnt/storage/immich_friend/k3s/encoded-video
            type: DirectoryOrCreate

        # Profile images - User avatars (SSD)
        - name: upload-profile
          hostPath:
            path: /mnt/ssd/immich_friend/k3s/profile
            type: DirectoryOrCreate

        # Upload staging - Temporary uploads (SSD)
        - name: upload-upload
          hostPath:
            path: /mnt/ssd/immich_friend/k3s/upload
            type: DirectoryOrCreate

        # Backups - Database dumps (HDD)
        - name: upload-backups
          hostPath:
            path: /mnt/storage/immich_friend/k3s/backups
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: immich
  namespace: immich-friend
spec:
  selector:
    app: immich
    tier: app
  ports:
    - port: 2283
      targetPort: 2283
      name: http
  type: ClusterIP
