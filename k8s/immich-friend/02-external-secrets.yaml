# ExternalSecret - Database Credentials
# ESO automatically syncs from Vault and creates/updates Kubernetes Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: immich-friend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
  data:
    - secretKey: password
      remoteRef:
        key: database
        property: password
---
# ExternalSecret - Authelia Secrets
# Syncs OAuth, JWT, session, storage, and OIDC HMAC secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: authelia-secrets
  namespace: immich-friend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: authelia-secrets
    creationPolicy: Owner
  data:
    - secretKey: oauth-client-secret
      remoteRef:
        key: oauth
        property: client_secret
    - secretKey: oauth-client-secret-hashed
      remoteRef:
        key: oauth
        property: client_secret_hashed
    - secretKey: jwt-secret
      remoteRef:
        key: jwt
        property: secret
    - secretKey: session-secret
      remoteRef:
        key: session
        property: secret
    - secretKey: storage-key
      remoteRef:
        key: storage
        property: key
    - secretKey: oidc-hmac-secret
      remoteRef:
        key: oidc-hmac
        property: secret
---
# ExternalSecret - Domain Configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: domain-secrets
  namespace: immich-friend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: domain-secrets
    creationPolicy: Owner
  data:
    - secretKey: base-domain
      remoteRef:
        key: domains
        property: base
    - secretKey: immich-domain
      remoteRef:
        key: domains
        property: immich
    - secretKey: authelia-domain
      remoteRef:
        key: domains
        property: authelia
    - secretKey: admin-email
      remoteRef:
        key: domains
        property: admin_email
# ---
# # ExternalSecret - Resend API Key (OPTIONAL - uncomment when you have API key)
# # Syncs email service API key from separate Vault path
# # To enable: 1) Add resend_api_key to terraform.tfvars, 2) Run tofu apply, 3) Uncomment this
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: resend-api-key
#   namespace: immich-friend
# spec:
#   refreshInterval: 1h
#   secretStoreRef:
#     name: vault-resend
#     kind: SecretStore
#   target:
#     name: resend-api-key
#     creationPolicy: Owner
#   data:
#   - secretKey: api-key
#     remoteRef:
#       key: api
#       property: key
# ---
# # SecretStore for Resend secrets (different Vault path)
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: vault-resend
#   namespace: immich-friend
# spec:
#   provider:
#     vault:
#       server: "http://vault.vault.svc.cluster.local:8200"
#       path: "resend"
#       version: "v2"
#       auth:
#         appRole:
#           path: "approle"
#           roleRef:
#             name: "vault-approle"
#             key: "role-id"
#           secretRef:
#             name: "vault-approle"
#             key: "secret-id"
