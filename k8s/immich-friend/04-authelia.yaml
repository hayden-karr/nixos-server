# Authelia - OAuth/OIDC Provider for Immich
apiVersion: apps/v1
kind: Deployment
metadata:
  name: authelia
  namespace: immich-friend
  labels:
    app: authelia
    tier: auth
spec:
  replicas: 1
  selector:
    matchLabels:
      app: authelia
      tier: auth
  template:
    metadata:
      labels:
        app: authelia
        tier: auth
    spec:
      enableServiceLinks: false

      initContainers:
        # Template the configuration with secrets from Vault (domains, admin email, OAuth hash)
        - name: config-template
          image: busybox:latest
          command: ["/bin/sh"]
          args:
            - -c
            - |
              set -e
              echo "Templating configuration with domain values..."
              cp /config-template/configuration.yml /config/configuration.yml

              # Extract values from secrets (remove trailing newlines)
              BASE_DOMAIN=$(cat /secrets/domains/base-domain | tr -d '\n')
              AUTHELIA_DOMAIN=$(cat /secrets/domains/authelia-domain | tr -d '\n')
              IMMICH_DOMAIN=$(cat /secrets/domains/immich-domain | tr -d '\n')
              ADMIN_EMAIL=$(cat /secrets/domains/admin-email | tr -d '\n')
              OAUTH_HASH=$(cat /secrets/authelia/oauth-client-secret-hashed | tr -d '\n')

              # Replace placeholders
              sed -i "s|BASE_DOMAIN_PLACEHOLDER|${BASE_DOMAIN}|g" /config/configuration.yml
              sed -i "s|AUTHELIA_DOMAIN_PLACEHOLDER|${AUTHELIA_DOMAIN}|g" /config/configuration.yml
              sed -i "s|IMMICH_DOMAIN_PLACEHOLDER|${IMMICH_DOMAIN}|g" /config/configuration.yml
              sed -i "s|ADMIN_EMAIL_PLACEHOLDER|${ADMIN_EMAIL}|g" /config/configuration.yml
              sed -i "s|OAUTH_CLIENT_SECRET_HASHED_PLACEHOLDER|${OAUTH_HASH}|g" /config/configuration.yml

              echo "Configuration templated successfully!"
          volumeMounts:
            - name: config-template
              mountPath: /config-template
              readOnly: true
            - name: config-processed
              mountPath: /config
            - name: domain-secrets
              mountPath: /secrets/domains
              readOnly: true
            - name: authelia-secrets
              mountPath: /secrets/authelia
              readOnly: true

        - name: setup
          image: authelia/authelia:latest
          command: ["/bin/sh"]
          args:
            - -c
            - |
              set -e
              if [ ! -f /data/oidc_rsa.pem ]; then
                echo "Generating RSA keys..."
                authelia crypto pair rsa generate --directory /data --file.private-key oidc_rsa.pem --file.public-key oidc_rsa.pub.pem
              fi
              if [ ! -f /data/users_database.yml ]; then
                echo "Creating default user with secure random password..."
                # Generate secure random password (16 chars, base64)
                TEMP_PASS=$(head -c 12 /dev/urandom | base64 | tr -d '+/=' | head -c 16)
                HASH=$(authelia crypto hash generate argon2 --password "$TEMP_PASS" 2>&1 | tail -1 | awk '{print $NF}')
                echo "users:" > /data/users_database.yml
                echo "  admin:" >> /data/users_database.yml
                echo "    disabled: false" >> /data/users_database.yml
                echo "    displayname: \"Admin User\"" >> /data/users_database.yml
                echo "    password: \"${HASH}\"" >> /data/users_database.yml
                echo "    email: ADMIN_EMAIL_PLACEHOLDER" >> /data/users_database.yml
                echo "    groups:" >> /data/users_database.yml
                echo "      - admins" >> /data/users_database.yml
                # Save password to file for one-time retrieval
                echo "Initial admin password: $TEMP_PASS" > /data/INITIAL_PASSWORD.txt
                chmod 600 /data/INITIAL_PASSWORD.txt
                echo "IMPORTANT: Initial password saved to /data/INITIAL_PASSWORD.txt"
                echo "Please change this password after first login!"
              fi
              touch /data/notification.txt
              echo "Setup complete!"
          volumeMounts:
            - name: data
              mountPath: /data

      containers:
        - name: authelia
          image: authelia/authelia:latest
          ports:
            - containerPort: 9091
              name: http
          env:
            - name: TZ
              value: America/Chicago
            - name: X_AUTHELIA_CONFIG_FILTERS
              value: "template"
            - name: AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: jwt-secret
            - name: AUTHELIA_SESSION_SECRET
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: session-secret
            - name: AUTHELIA_STORAGE_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: storage-key
            - name: AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: oidc-hmac-secret
          volumeMounts:
            - name: config-processed
              mountPath: /config
              readOnly: true
            - name: data
              mountPath: /data
            - name: tmp
              mountPath: /tmp
          securityContext:
            allowPrivilegeEscalation: false
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

      volumes:
        - name: config-template
          configMap:
            name: authelia-config
        - name: config-processed
          emptyDir: {}
        - name: domain-secrets
          secret:
            secretName: domain-secrets
        - name: authelia-secrets
          secret:
            secretName: authelia-secrets
        - name: data
          persistentVolumeClaim:
            claimName: authelia-data
        - name: tmp
          emptyDir: {}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: authelia-data
  namespace: immich-friend
  annotations:
    volumeType: local
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: authelia
  namespace: immich-friend
spec:
  selector:
    app: authelia
    tier: auth
  ports:
    - port: 9091
      targetPort: 9091
      name: http
  type: ClusterIP
